# ──────────────────────────────────────────────────────────────
# CVE-Scan – Täglicher Sicherheits-Scan der Abhängigkeiten
# ──────────────────────────────────────────────────────────────
# Scannt Python pip (setup.py), Rust Crates (Cargo.lock) und
# ROS 2 (package.xml) Abhängigkeiten gegen die Google OSV API
# und GitHub Advisory Database.
# Bei CVSS >= 7.0 wird ein GitHub Issue als Alert erstellt.
#
# Trigger: Täglich 06:00 UTC  |  Manuell via workflow_dispatch
# ──────────────────────────────────────────────────────────────

name: CVE-Scan

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  cve-scan:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Python 3.12 einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Scanner-Abhängigkeiten installieren
        run: pip install -r security/requirements.txt

      - name: CVE-Scan ausführen
        id: scan
        run: |
          python security/cve_scanner.py || true

      - name: Report committen
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p security/reports
          git add -f security/reports/ || echo "Nichts zum Adden."
          git diff --cached --quiet && echo "Keine Änderungen." && exit 0
          git commit -m "security: CVE-Scan Report $(date -u +%Y-%m-%d)"
          git push

      - name: Issue-Alert bei kritischen CVEs
        if: steps.scan.outputs.high_severity == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO_FULL: ${{ github.repository }}
          HIGH_COUNT: ${{ steps.scan.outputs.high_count }}
        run: |
          set -e
          DATE=$(date -u +%Y-%m-%d)
          TITLE="⚠️ CVE-Alert: ${HIGH_COUNT} kritische Schwachstelle(n) (${DATE})"

          gh label create "cve-alert" \
            --description "CVE-Alert: Kritische Schwachstelle (CVSS >= 7.0)" \
            --color "d73a4a" 2>/dev/null || true

          EXISTING=$(gh issue list \
            --label "cve-alert" \
            --search "${DATE}" \
            --state open \
            --json number --jq 'length' 2>/dev/null || echo "0")
          if [ "$EXISTING" -gt "0" ]; then
            echo "Issue für heute existiert bereits – übersprungen."
            exit 0
          fi

          {
            if [ -f security/reports/alert_high_severity.txt ]; then
              cat security/reports/alert_high_severity.txt
            else
              echo "${HIGH_COUNT} Schwachstelle(n) mit CVSS >= 7.0 gefunden. Details: security/reports/cve_report.md"
            fi
            echo ""
            echo "---"
            echo "**Report:** [cve_report.md](https://github.com/${REPO_FULL}/blob/main/security/reports/cve_report.md)"
            echo "*Automatisch erstellt von GitHub Actions (CVE-Scan Workflow).*"
          } > /tmp/issue_body.md

          ISSUE_URL=$(
            gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md \
              --label "cve-alert" \
              --assignee "Bheowulf" 2>/dev/null \
            || gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md \
              --label "cve-alert" 2>/dev/null \
            || gh issue create \
              --title "${TITLE}" \
              --body-file /tmp/issue_body.md
          )
          echo "✅ Issue erstellt: ${ISSUE_URL}"
